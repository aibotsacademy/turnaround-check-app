<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnaround Check - Photo Complete</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            width: 100%; max-width: 100%;
            overflow-x: hidden;
            height: 100%; height: 100dvh;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #e2e8f0;
            /* Full-screen app shell */
            display: flex; flex-direction: column;
        }

        /* ‚îÄ‚îÄ BACKGROUND CANVAS ‚îÄ‚îÄ */
        #canvas-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
        .app-shell {
            position: relative; z-index: 2;
            display: flex; flex-direction: column;
            width: 100%; max-width: 480px;
            margin: 0 auto;
            height: 100vh; height: 100dvh;
            overflow: hidden; /* shell never scrolls */
        }

        /* ‚îÄ‚îÄ STICKY HEADER ‚îÄ‚îÄ */
        .app-header {
            flex-shrink: 0;
            background: rgba(5, 8, 22, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(59,130,246,0.2);
            padding: 10px 16px 0;
            z-index: 10;
        }

        .header-row {
            display: flex; align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .header-title {
            font-size: 17px; font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .header-actions { display: flex; gap: 7px; align-items: center; }

        .btn-header-hist {
            background: rgba(139,92,246,0.2);
            border: 1px solid rgba(139,92,246,0.4);
            color: #c4b5fd; border-radius: 8px;
            padding: 6px 11px; font-size: 12px; font-weight: 600;
            cursor: pointer; white-space: nowrap;
        }
        .btn-header-hist:active { background: rgba(139,92,246,0.35); }

        .user-role-chip {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            padding: 4px 10px; border-radius: 7px;
            font-weight: 600; color: #fff; font-size: 11px;
            white-space: nowrap;
        }

        .user-name {
            color: #94a3b8; font-size: 12px;
            white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; max-width: 100px;
        }

        /* ‚îÄ‚îÄ PROGRESS BAR (part of header) ‚îÄ‚îÄ */
        .progress-bar {
            width: 100%; height: 3px;
            background: rgba(59,130,246,0.12);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.35s ease;
            width: 0%;
        }

        /* ‚îÄ‚îÄ STEP COUNTER (part of header) ‚îÄ‚îÄ */
        .step-counter {
            text-align: center; color: #64748b;
            font-size: 11px; font-weight: 500;
            padding: 6px 0 8px;
            letter-spacing: 0.3px;
        }

        /* ‚îÄ‚îÄ SCROLLABLE CONTENT ‚îÄ‚îÄ */
        .app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 16px 16px 32px;
        }
        /* thin scrollbar on Android Chrome */
        .app-content::-webkit-scrollbar { width: 4px; }
        .app-content::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.3); border-radius: 4px; }

        /* ‚îÄ‚îÄ CARDS / QUESTION CARDS ‚îÄ‚îÄ */
        .question-card { display: none; animation: fadeIn 0.3s ease; }
        .question-card.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .question-title {
            color: #fff; font-size: 20px; margin-bottom: 6px;
            font-weight: 700; text-align: center; line-height: 1.2;
        }
        .question-subtitle {
            color: #64748b; font-size: 13px;
            margin-bottom: 18px; text-align: center;
        }

        /* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
        .camera-container {
            position: relative; width: 100%;
            aspect-ratio: 4/3; background: #000;
            border-radius: 14px; overflow: hidden; margin-bottom: 12px;
        }
        #video, #canvas { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; }
        .camera-overlay { position: absolute; inset: 0; pointer-events: none; }
        .camera-label {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            background: rgba(59,130,246,0.9); color: #fff;
            padding: 5px 14px; border-radius: 20px;
            font-size: 11px; font-weight: 600; white-space: nowrap;
        }
        .camera-corners { position: absolute; width: 22px; height: 22px; border: 3px solid #3b82f6; }
        .corner-tl { top: 9%; left: 9%; border-right: none; border-bottom: none; }
        .corner-tr { top: 9%; right: 9%; border-left: none; border-bottom: none; }
        .corner-bl { bottom: 9%; left: 9%; border-right: none; border-top: none; }
        .corner-br { bottom: 9%; right: 9%; border-left: none; border-top: none; }
        .timestamp-display {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.72); color: #fff;
            padding: 4px 10px; border-radius: 7px;
            font-size: 10px; font-family: 'Courier New', monospace; font-weight: 600;
        }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .capture-btn {
            width: 100%; padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none; border-radius: 12px; color: #fff;
            font-size: 15px; font-weight: 600; cursor: pointer;
            margin-bottom: 12px; transition: opacity 0.2s;
        }
        .capture-btn:active { opacity: 0.8; }
        .capture-btn:disabled { opacity: 0.45; }

        .captured-photo {
            width: 100%; aspect-ratio: 4/3;
            object-fit: cover; border-radius: 14px; margin-bottom: 12px;
        }
        .photo-actions { display: flex; gap: 9px; margin-bottom: 12px; }
        .retake-btn {
            flex: 1; padding: 12px;
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.45);
            border-radius: 11px; color: #fca5a5;
            font-size: 13px; font-weight: 600; cursor: pointer;
        }
        .retake-btn:active { background: rgba(239,68,68,0.28); }
        .confirm-btn {
            flex: 2; padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none; border-radius: 11px; color: #fff;
            font-size: 13px; font-weight: 600; cursor: pointer;
        }
        .confirm-btn:active { opacity: 0.82; }

        .navigation-buttons { display: flex; gap: 9px; margin-top: 16px; }
        .nav-btn {
            flex: 1; padding: 13px; border: none;
            border-radius: 11px; font-size: 14px;
            font-weight: 600; cursor: pointer;
        }
        .nav-btn-prev {
            background: rgba(71,85,105,0.28);
            color: #cbd5e1; border: 1px solid rgba(71,85,105,0.45);
        }
        .nav-btn-prev:active { background: rgba(71,85,105,0.45); }
        .nav-btn-next {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: #fff;
        }
        .nav-btn-next:active { opacity: 0.82; }
        .nav-btn:disabled { opacity: 0.45; pointer-events: none; }

        /* ‚îÄ‚îÄ CHECKPOINT ACTIONS (‚ö†Ô∏è skip row) ‚îÄ‚îÄ */
        .checkpoint-actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-skip-incident {
            flex: 1; padding: 12px 8px;
            background: rgba(245,158,11,0.12);
            border: 1px solid rgba(245,158,11,0.4);
            border-radius: 10px; color: #fbbf24;
            font-size: 12px; font-weight: 600; cursor: pointer;
            font-family: inherit;
        }
        .btn-skip-incident:active { background: rgba(245,158,11,0.24); }
        .btn-resume-here {
            flex: 1; padding: 12px 8px;
            background: rgba(16,185,129,0.12);
            border: 1px solid rgba(16,185,129,0.4);
            border-radius: 10px; color: #6ee7b7;
            font-size: 12px; font-weight: 600; cursor: pointer;
            font-family: inherit;
        }
        .btn-resume-here:active { background: rgba(16,185,129,0.24); }

        /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
        select, input[type="text"] {
            width: 100%; padding: 13px 16px;
            background: rgba(30,41,59,0.6);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 11px; color: #fff;
            font-size: 15px; outline: none;
        }
        select:focus, input[type="text"]:focus {
            border-color: #3b82f6;
            background: rgba(30,41,59,0.85);
        }
        select option { background: #1e293b; color: #fff; }

        textarea {
            width: 100%; min-height: 75px; padding: 11px;
            background: rgba(30,41,59,0.6);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 11px; color: #fff;
            font-size: 13px; outline: none; resize: vertical;
            font-family: inherit; margin-top: 12px;
        }
        textarea:focus { border-color: #3b82f6; }

        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; color: #cbd5e1;
            font-size: 13px; margin-bottom: 7px; font-weight: 500;
        }

        .radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .radio-option {
            flex: 1; min-width: 80px; padding: 9px;
            background: rgba(30,41,59,0.4);
            border: 2px solid rgba(59,130,246,0.2);
            border-radius: 9px; cursor: pointer; text-align: center;
        }
        .radio-option:active { background: rgba(59,130,246,0.12); }
        .radio-option.selected { background: rgba(59,130,246,0.2); border-color: #3b82f6; }
        .radio-option input { display: none; }
        .radio-option label { color: #cbd5e1; font-size: 13px; cursor: pointer; margin: 0; }

        .briefing-topics { display: grid; grid-template-columns: 1fr; gap: 8px; margin: 14px 0; }
        .topic-item {
            display: flex; align-items: center;
            padding: 11px 13px;
            background: rgba(30,41,59,0.4);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 9px; cursor: pointer;
        }
        .topic-item:active { background: rgba(59,130,246,0.1); }
        .topic-item input[type="checkbox"] { width: 17px; height: 17px; margin-right: 9px; cursor: pointer; flex-shrink: 0; }
        .topic-item label { color: #cbd5e1; font-size: 13px; cursor: pointer; flex: 1; }

        .optional-badge {
            display: inline-block;
            background: rgba(251,191,36,0.18); color: #fbbf24;
            padding: 3px 10px; border-radius: 5px;
            font-size: 10px; font-weight: 600; margin-left: 8px;
            border: 1px solid rgba(251,191,36,0.3);
        }

        /* ‚îÄ‚îÄ PHOTO SELECTOR ‚îÄ‚îÄ */
        .photo-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
        .photo-selector-item {
            position: relative; aspect-ratio: 4/3;
            border-radius: 9px; overflow: hidden; cursor: pointer;
            border: 3px solid transparent;
        }
        .photo-selector-item:active { border-color: rgba(59,130,246,0.5); }
        .photo-selector-item.selected { border-color: #3b82f6; }
        .photo-selector-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-selector-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8); color: #fff;
            padding: 4px; font-size: 9px; text-align: center;
        }

        /* ‚îÄ‚îÄ COMPLETION SCREEN ‚îÄ‚îÄ */
        .completion-screen { display: none; }
        .completion-screen.active { display: block; }
        .completion-icon { font-size: 60px; margin-bottom: 14px; text-align: center; animation: bounce 1s ease; }
        @keyframes bounce { 0%,20%,50%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-16px); } 60% { transform: translateY(-8px); } }
        .completion-title { color: #fff; font-size: 26px; margin-bottom: 14px; font-weight: 700; text-align: center; }

        .summary-card {
            background: rgba(30,41,59,0.4);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 14px; padding: 18px; margin-bottom: 14px;
        }
        .summary-title { color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 14px; }
        .summary-item {
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 8px;
            padding: 9px 0; border-bottom: 1px solid rgba(59,130,246,0.1);
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { color: #64748b; font-size: 13px; flex-shrink: 0; }
        .summary-value { color: #fff; font-weight: 600; font-size: 13px; text-align: right; }

        .photo-gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 14px; }
        .gallery-item { position: relative; aspect-ratio: 4/3; border-radius: 10px; overflow: hidden; background: rgba(30,41,59,0.4); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.88); color: #fff; padding: 5px; font-size: 9px; text-align: center; }
        .gallery-timestamp { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.78); padding: 3px 7px; border-radius: 5px; font-size: 9px; font-family: 'Courier New', monospace; font-weight: 600; }

        .time-diff { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; font-family: 'Courier New', monospace; margin-left: 6px; }
        .time-diff.negative { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .time-diff.optimal  { background: rgba(16,185,129,0.2); color: #6ee7b7; }
        .time-diff.warning  { background: rgba(251,191,36,0.2); color: #fcd34d; }
        .time-diff.critical { background: rgba(239,68,68,0.2); color: #fca5a5; }

        .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-primary {
            padding: 14px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none; border-radius: 11px; color: #fff;
            font-size: 15px; font-weight: 600; cursor: pointer;
        }
        .btn-primary:active { opacity: 0.82; }
        .btn-secondary {
            padding: 13px;
            background: rgba(71,85,105,0.28); color: #cbd5e1;
            border: 1px solid rgba(71,85,105,0.45);
            border-radius: 11px; cursor: pointer;
            font-size: 14px; font-weight: 600;
        }
        .btn-secondary:active { background: rgba(71,85,105,0.45); }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div class="app-shell">
        <!-- ‚îÄ‚îÄ STICKY HEADER ‚îÄ‚îÄ -->
        <header class="app-header">
            <div class="header-row">
                <span class="header-title">‚úàÔ∏è Turnaround</span>
                <div class="header-actions">
                    <span class="user-name" id="usernameDisplay">Cargando‚Ä¶</span>
                    <button class="btn-header-hist" onclick="goToHistory()">üìã Historial</button>
                    <span class="user-role-chip" id="userRole">‚Ä¶</span>
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            <div class="step-counter" id="stepCounter">Seleccione la aerol√≠nea</div>
        </header>

        <!-- ‚îÄ‚îÄ SCROLLABLE CONTENT ‚îÄ‚îÄ -->
        <div class="app-content">
            
            <div id="step0" class="question-card active">
                <h2 class="question-title">Aerol√≠nea</h2>
                <p class="question-subtitle">Seleccione la aerol√≠nea del vuelo</p>
                <select id="airlineSelect" onchange="handleAirlineSelection(this.value)">
                    <option value="">Seleccione una aerol√≠nea</option>
                    <option value="DL">Delta</option>
                    <option value="WN">Southwest</option>
                    <option value="AV">Avianca</option>
                    <option value="UA">United</option>
                    <option value="AA">American Airlines</option>
                    <option value="WS">Westjet</option>
                    <option value="E9">Iberojet</option>
                    <option value="PO">Porter</option>
                </select>
            </div>
            
            <div id="step0.3" class="question-card">
                <h2 class="question-title">Tipo de Vuelo</h2>
                <p class="question-subtitle">Seleccione el tipo de operaci√≥n</p>
                <select id="flightTypeSelect" onchange="handleFlightTypeSelection(this.value)">
                    <option value="">-- Seleccione --</option>
                    <option value="TURN">TURN (Turnaround)</option>
                    <option value="RON-ARRIVAL">RON - Llegada (Arrival)</option>
                    <option value="RON-DEPARTURE">RON - Salida (Departure)</option>
                </select>
                <div class="navigation-buttons">
                    <button class="nav-btn nav-btn-prev" onclick="goBackToAirline()">‚Üê Anterior</button>
                </div>
            </div>
            
            <div id="step0.5" class="question-card">
                <h2 class="question-title">N√∫mero de Vuelo</h2>
                <p class="question-subtitle">Ingrese el n√∫mero del vuelo</p>
                <input type="text" id="flightNumber" placeholder="Ej: 1234">
                <div class="navigation-buttons">
                    <button class="nav-btn nav-btn-prev" onclick="goBackToFlightType()">‚Üê Anterior</button>
                    <button class="nav-btn nav-btn-next" onclick="submitFlightNumber()">Continuar ‚Üí</button>
                </div>
            </div>
            
            <div id="step1" class="question-card">
                <div id="checkpointContainer"></div>
            </div>
            
            <div id="step-incident" class="question-card">
                <h2 class="question-title">Incidentes y Observaciones</h2>
                <p class="question-subtitle">Reporte cualquier incidente ocurrido durante la inspecci√≥n</p>
                <div class="form-group">
                    <label>¬øSe present√≥ alg√∫n incidente?</label>
                    <div class="radio-group">
                        <div class="radio-option" onclick="toggleIncidentForm(true)">
                            <input type="radio" name="hasIncident" value="si" id="incidentSi">
                            <label for="incidentSi">S√≠</label>
                        </div>
                        <div class="radio-option" onclick="toggleIncidentForm(false)">
                            <input type="radio" name="hasIncident" value="no" id="incidentNo" checked>
                            <label for="incidentNo">No</label>
                        </div>
                    </div>
                </div>
                <div id="incidentForm" class="incident-form" style="display: none;">
                    <div class="form-group">
                        <label>Tipo de Incidente</label>
                        <select id="incidentType">
                            <option value="">-- Seleccione --</option>
                            <option value="Da√±o a Aeronave">Da√±o a Aeronave</option>
                            <option value="Retraso Operacional">Retraso Operacional</option>
                            <option value="Equipo Defectuoso">Equipo Defectuoso</option>
                            <option value="FOD Encontrado">FOD Encontrado</option>
                            <option value="Derrame">Procedimiento Seguridad</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Severidad</label>
                        <div class="radio-group">
                            <div class="radio-option" onclick="selectSeverity('Baja')">
                                <input type="radio" name="severity" value="Baja" id="sevBaja">
                                <label for="sevBaja">Baja</label>
                            </div>
                            <div class="radio-option" onclick="selectSeverity('Media')">
                                <input type="radio" name="severity" value="Media" id="sevMedia">
                                <label for="sevMedia">Media</label>
                            </div>
                            <div class="radio-option" onclick="selectSeverity('Alta')">
                                <input type="radio" name="severity" value="Alta" id="sevAlta">
                                <label for="sevAlta">Alta</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n del Incidente</label>
                        <textarea id="incidentDescription" placeholder="Describa detalladamente el incidente..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Seleccione foto de evidencia (opcional)</label>
                        <p style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Seleccione una de las fotos capturadas durante la inspecci√≥n</p>
                        <div class="photo-selector" id="incidentPhotoSelector"></div>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-btn nav-btn-prev" onclick="returnToCheckpoint()">‚Üê Regresar</button>
                    <button class="nav-btn nav-btn-next" onclick="completeInspection()">Finalizar Inspecci√≥n ‚úì</button>
                </div>
                <div class="checkpoint-actions" style="margin-top:10px;">
                    <button class="btn-resume-here" style="flex:1;padding:13px;" onclick="saveReportNow()">üíæ Guardar Reporte</button>
                </div>
            </div>
            
            <div class="completion-screen" id="completionScreen">
                <div class="completion-icon">üéâ</div>
                <h2 class="completion-title">¬°Inspecci√≥n Completada!</h2>
                <div class="summary-card">
                    <div class="summary-title">‚úàÔ∏è Informaci√≥n del Vuelo</div>
                    <div class="summary-item"><span class="summary-label">Aerol√≠nea:</span><span class="summary-value" id="summaryAirline"></span></div>
                    <div class="summary-item"><span class="summary-label">Tipo:</span><span class="summary-value" id="summaryFlightType"></span></div>
                    <div class="summary-item"><span class="summary-label">Vuelo:</span><span class="summary-value" id="summaryFlight"></span></div>
                    <div class="summary-item"><span class="summary-label">Inspector:</span><span class="summary-value" id="summaryInspector"></span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">üìä M√©tricas de Inspecci√≥n</div>
                    <div class="summary-item"><span class="summary-label">Fotos Capturadas:</span><span class="summary-value" id="summaryPhotoCount"></span></div>
                    <div class="summary-item"><span class="summary-label">Checkpoints Completados:</span><span class="summary-value" id="summaryCheckpoints"></span></div>
                </div>
                <div class="summary-card" id="timeMetricsCard" style="display: none;">
                    <div class="summary-title">‚è±Ô∏è M√©tricas de Tiempo vs Beacon OFF</div>
                    <div id="timeMetricsContent" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="summary-card" id="incidentCard" style="display: none;">
                    <div class="summary-title" style="color: #fca5a5;">‚ö†Ô∏è Incidente Reportado</div>
                    <div id="incidentSummary"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">üñºÔ∏è Galer√≠a de Evidencias</div>
                    <div class="photo-gallery" id="photoGallery"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="newReport()">üîÑ Nueva Inspecci√≥n</button>
                    <button class="btn-primary" onclick="goToHistory()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);">üìã Ver Historial</button>
                    <button class="btn-secondary" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcOVO2ZzHHix-6umAldYbrxhFV05QtVHmDjixr0lg6jvugPUB3PHRw7-hF67V7MN-05Q/exec';
        let inspectionUser = { username: '', role: 'Inspector' };
        let selectedAirline = '', selectedFlightType = '', flightNumberValue = '', flightTimestamp = '';
        let currentCheckpointIndex = 0, checkpoints = [], capturedPhotos = {};
        let currentPhotoData = null, currentTimestamp = null, stream = null, beaconOffTime = null;
        let briefingTopics = [], briefingNotes = '', incidentData = null, selectedIncidentPhoto = null;
        
        const userDataString = sessionStorage.getItem('user');
        if (userDataString) {
            try {
                const userData = JSON.parse(userDataString);
                inspectionUser = { username: userData.username, role: userData.role };
                document.getElementById('usernameDisplay').textContent = inspectionUser.username;
                document.getElementById('userRole').textContent = inspectionUser.role;
            } catch (error) {
                alert('Sesi√≥n inv√°lida. Por favor inicie sesi√≥n nuevamente.');
                window.location.href = 'login-Photo9.html';
            }
        } else {
            alert('Por favor inicie sesi√≥n primero.');
            window.location.href = 'login-Photo9.html';
        }
        
        const BRIEFING_TOPICS = [
            { id: 'seguridad', label: 'Confirmar equipos de trabajo' },
            { id: 'horarios', label: 'Seguridad y procedimientos' },
            { id: 'equipaje', label: 'Manejo de equipaje especial' },
            { id: 'combustible', label: 'Requerimientos especial de carga' },
            { id: 'pasajeros', label: 'Encargado y supervisor rampa' },
            { id: 'clima', label: 'Respetar pulgadas de bin' },
            { id: 'mantenimiento', label: 'Tener EPP (Equipo de protecci√≥n)' },
            { id: 'emergencias', label: 'Procedimientos de emergencia' }
        ];
        
        // ‚îÄ‚îÄ CHECKPOINT LABELS MATCH EXACT SHEET COLUMN HEADERS ‚îÄ‚îÄ
        const QUESTIONS = {
            TURN: [
                { key: 'briefing',               label: 'Briefing',                  emoji: '‚ö°', type: 'briefing' },
                { key: 'inicio_fod',             label: 'Inicio FOD',                emoji: 'üîç' },
                { key: 'beacon_off',             label: 'Beacon OFF',                emoji: 'üö®' },
                { key: 'planta_electrica',       label: 'Planta El√©ctrica',          emoji: '‚ö°', optional: true },
                { key: 'aire_acondicionado',     label: 'Aire Acondicionado',        emoji: '‚ùÑÔ∏è', optional: true },
                { key: 'banda',                  label: 'Banda',                     emoji: 'üì¶' },
                { key: 'escalera',               label: 'Escalera',                  emoji: 'ü™ú', optional: true },
                { key: 'inicia_descarga_carga',  label: 'Inicia Descarga Carga',     emoji: 'üõÑ' },
                { key: 'waste_water',            label: 'Waste & Water',             emoji: 'üíß' },
                { key: 'descarga_equipaje',      label: 'Finaliza Descarga Carga',   emoji: 'üõÑ' },
                { key: 'inicia_equipaje',        label: 'Inicia Descarga Equipaje',  emoji: 'üõÑ' },
                { key: 'finaliza_equipaje',      label: 'Finaliza Descarga Equipaje',emoji: 'üõÑ' },
                { key: 'sube_limpieza',          label: 'Sube Limpieza',             emoji: 'üßπ' },
                { key: 'baja_limpieza',          label: 'Baja Limpieza',             emoji: 'üßπ' },
                { key: 'segundo_fod',            label: '2do FOD',                   emoji: 'üîç' },
                { key: 'ultimo_viaje_carreta',   label: '√öltimo Viaje Carreta',      emoji: 'üöö' },
                { key: 'inicia_carga_maleta',    label: 'Inicia Carga Maleta',       emoji: 'üß≥' },
                { key: 'ultima_maleta',          label: '√öltima Maleta',             emoji: 'üß≥' },
                { key: 'towbar',                 label: 'Towbar',                    emoji: 'üîß' },
                { key: 'cierre_bines',           label: 'Cierre Bines',              emoji: 'üö™' },
                { key: 'push_back',              label: 'Push Back',                 emoji: '‚¨ÖÔ∏è' },
                { key: 'tercer_fod',             label: '3er FOD',                   emoji: 'üîç' },
                { key: 'en_aire',                label: 'En el Aire',                emoji: '‚úàÔ∏è' }
            ],
            'RON-ARRIVAL': [
                { key: 'briefing',          label: 'Briefing',                  emoji: '‚ö°', type: 'briefing' },
                { key: 'fod',               label: 'FOD',                       emoji: 'üîç' },
                { key: 'beacon_off',        label: 'Beacon OFF',                emoji: 'üö®' },
                { key: 'planta_electrica',  label: 'Planta El√©ctrica',          emoji: '‚ö°', optional: true },
                { key: 'aire_acondicionado',label: 'Aire Acondicionado',        emoji: '‚ùÑÔ∏è', optional: true },
                { key: 'banda',             label: 'Banda',                     emoji: 'üì¶' },
                { key: 'escalera',          label: 'Escalera',                  emoji: 'ü™ú', optional: true },
                { key: 'inicia_descarga',   label: 'Inicia Descarga Equipaje',  emoji: 'üõÑ' },
                { key: 'finaliza_descarga', label: 'Finaliza Descarga Equipaje',emoji: 'üõÑ' },
                { key: 'inicia_carga',      label: 'Inicia Descarga Carga',     emoji: 'üõÑ' },
                { key: 'finaliza_carga',    label: 'Finaliza Descarga Carga',   emoji: 'üõÑ' },
                { key: 'waste_water',       label: 'Waste & Water',             emoji: 'üíß' },
                { key: 'sube_limpieza',     label: 'Sube Limpieza',             emoji: 'üßπ' },
                { key: 'baja_limpieza',     label: 'Baja Limpieza',             emoji: 'üßπ' },
                { key: 'segundo_fod',       label: '2do FOD',                   emoji: 'üîç' },
                { key: 'ultimo_viaje_carreta', label: '√öltimo Viaje Carreta',   emoji: 'üöö' },
                { key: 'cierre_bines',      label: 'Cierre Bines',              emoji: 'üö™' },
                { key: 'towbar',            label: 'Towbar',                    emoji: 'üîß' }
            ],
            'RON-DEPARTURE': [
                { key: 'briefing',              label: 'Briefing',              emoji: '‚ö°', type: 'briefing' },
                { key: 'fod',                   label: 'FOD',                   emoji: 'üîç' },
                { key: 'avion_posicion',        label: 'Avi√≥n en Posici√≥n',     emoji: '‚úàÔ∏è' },
                { key: 'planta_electrica',      label: 'Planta El√©ctrica',      emoji: '‚ö°', optional: true },
                { key: 'aire_acondicionado',    label: 'Aire Acondicionado',    emoji: '‚ùÑÔ∏è', optional: true },
                { key: 'banda',                 label: 'Banda',                 emoji: 'üì¶' },
                { key: 'escalera',              label: 'Escalera',              emoji: 'ü™ú', optional: true },
                { key: 'inicia_carga',          label: 'Inicia Carga de Equipaje', emoji: 'üõÑ' },
                { key: 'waste_water',           label: 'Waste & Water',         emoji: 'üíß', optional: true },
                { key: 'segundo_fod',           label: '2do FOD',               emoji: 'üîç' },
                { key: 'finaliza_carga',        label: 'Finaliza Carga Equipaje', emoji: 'üõÑ' },
                { key: 'inicia_carga_carga',    label: 'Inicia carga de Carga', emoji: 'üõÑ' },
                { key: 'finaliza_carga_carga',  label: 'Finaliza carga de Carga', emoji: 'üõÑ' },
                { key: 'towbar',                label: 'Towbar',                emoji: 'üîß' },
                { key: 'cierre_bines',          label: 'Cierre Bines',          emoji: 'üö™' },
                { key: 'push_back',             label: 'Pushback',              emoji: 'üîß' },
                { key: 'tercer_fod',            label: '3er FOD',               emoji: 'üîç' }
            ]
        };
        
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 3000;
        const posArray = new Float32Array(particlesCount * 3);
        for(let i = 0; i < particlesCount * 3; i++) { posArray[i] = (Math.random() - 0.5) * 100; }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({ size: 0.08, color: 0x3b82f6, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending });
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
        camera.position.z = 30;
        function animate() { requestAnimationFrame(animate); particlesMesh.rotation.y += 0.001; particlesMesh.rotation.x += 0.0005; renderer.render(scene, camera); }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        
        function handleAirlineSelection(value) { if (!value) return; selectedAirline = value; hideStep(0); showStep(0.3); document.getElementById('stepCounter').textContent = 'Tipo de Vuelo'; }
        function goBackToAirline() { hideStep(0.3); showStep(0); document.getElementById('stepCounter').textContent = 'Seleccione la aerol√≠nea'; document.getElementById('flightTypeSelect').value = ''; }
        function handleFlightTypeSelection(value) { if (!value) return; selectedFlightType = value; hideStep(0.3); showStep(0.5); document.getElementById('stepCounter').textContent = 'N√∫mero de Vuelo'; }
        function goBackToFlightType() { hideStep(0.5); showStep(0.3); document.getElementById('stepCounter').textContent = 'Tipo de Vuelo'; }
        function submitFlightNumber() { flightNumberValue = document.getElementById('flightNumber').value.trim(); if (!flightNumberValue) { alert('Por favor ingrese el n√∫mero de vuelo'); return; } flightTimestamp = new Date().toISOString(); startPhotoInspection(); }
        function showStep(step) { const stepId = step === 0 ? 'step0' : step === 0.3 ? 'step0.3' : step === 0.5 ? 'step0.5' : 'step1'; const element = document.getElementById(stepId); if (element) element.classList.add('active'); }
        function hideStep(step) { const stepId = step === 0 ? 'step0' : step === 0.3 ? 'step0.3' : step === 0.5 ? 'step0.5' : 'step1'; const element = document.getElementById(stepId); if (element) element.classList.remove('active'); }
        
        function startPhotoInspection() { checkpoints = QUESTIONS[selectedFlightType] || []; currentCheckpointIndex = 0; capturedPhotos = []; hideStep(0.5); showStep(1); renderCheckpoint(); }
        
        function renderCheckpoint() {
            const checkpoint = checkpoints[currentCheckpointIndex];
            if (!checkpoint) { goToIncidents(); return; }
            const container = document.getElementById('checkpointContainer');
            const progress = ((currentCheckpointIndex + 1) / checkpoints.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('stepCounter').textContent = `Checkpoint ${currentCheckpointIndex + 1} de ${checkpoints.length}`;
            const optionalBadge = checkpoint.optional ? '<span class="optional-badge">Opcional</span>' : '';
            
            if (checkpoint.type === 'briefing') {
                container.innerHTML = `
                    <h2 class="question-title">${checkpoint.emoji} ${checkpoint.label}${optionalBadge}</h2>
                    <p class="question-subtitle">Seleccione los temas tratados en el briefing</p>
                    <div class="briefing-topics">
                        ${BRIEFING_TOPICS.map(topic => `
                            <div class="topic-item">
                                <input type="checkbox" id="topic-${topic.id}" value="${topic.label}">
                                <label for="topic-${topic.id}">${topic.label}</label>
                            </div>
                        `).join('')}
                    </div>
                    <textarea id="briefingNotes" placeholder="Comentarios adicionales del briefing..."></textarea>
                    <div class="navigation-buttons" style="margin-top: 20px;">
                        ${currentCheckpointIndex > 0 ? '<button class="nav-btn nav-btn-prev" onclick="previousCheckpoint()">‚Üê Anterior</button>' : ''}
                        <button class="nav-btn nav-btn-next" onclick="saveBriefingAndContinue()">Siguiente ‚Üí</button>
                    </div>
                    <div class="checkpoint-actions" style="margin-top:10px;">
                        <button class="btn-skip-incident" onclick="skipToIncidents()">‚ö†Ô∏è Ir a Incidentes</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h2 class="question-title">${checkpoint.emoji} ${checkpoint.label}${optionalBadge}</h2>
                    <p class="question-subtitle">Capture una foto de este checkpoint</p>
                    
                    <div id="photoHistory" style="display: none; margin-bottom: 20px;"></div>
                    
                    <div id="cameraView" style="display: none;">
                        <div class="camera-container">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas"></canvas>
                            <div class="camera-overlay">
                                <div class="camera-label">${checkpoint.label}</div>
                                <div class="camera-corners corner-tl"></div>
                                <div class="camera-corners corner-tr"></div>
                                <div class="camera-corners corner-bl"></div>
                                <div class="camera-corners corner-br"></div>
                                <div class="timestamp-display" id="liveTimestamp">00:00:00</div>
                            </div>
                        </div>
                        <button class="capture-btn" onclick="capturePhoto()">üì∏ Capturar Foto</button>
                    </div>
                    <div id="photoPreview" style="display: none;">
                        <img id="capturedImage" class="captured-photo">
                        <div style="text-align: center; color: #fbbf24; font-size: 14px; margin-bottom: 10px;" id="capturedTimestamp"></div>
                        <div class="photo-actions">
                            <button class="retake-btn" onclick="retakePhoto()">üîÑ Tomar Otra</button>
                            <button class="confirm-btn" onclick="confirmPhoto()">‚úì Confirmar Foto</button>
                        </div>
                    </div>
                    <button class="capture-btn" id="startCameraBtn" onclick="startCamera()">üì∑ Iniciar C√°mara</button>
                    <div class="navigation-buttons" style="margin-top: 20px;">
                        ${currentCheckpointIndex > 0 ? '<button class="nav-btn nav-btn-prev" onclick="previousCheckpoint()">‚Üê Anterior</button>' : ''}
                        ${checkpoint.optional ? 
                            '<button class="nav-btn nav-btn-next" onclick="skipCheckpoint()">Omitir ‚Üí</button>' : 
                            '<button class="nav-btn nav-btn-next" onclick="nextCheckpoint()">Siguiente ‚Üí</button>'
                        }
                    </div>
                    <div class="checkpoint-actions">
                        <button class="btn-skip-incident" onclick="skipToIncidents()">‚ö†Ô∏è Ir a Incidentes</button>
                    </div>
                `;
            }
            
            const existingPhotos = capturedPhotos[checkpoint.key];
            if (existingPhotos && existingPhotos.length > 0) {
                const historyDiv = document.getElementById('photoHistory');
                if (historyDiv) {
                    historyDiv.style.display = 'block';
                    historyDiv.innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <div style="color: #6ee7b7; font-size: 14px; font-weight: 600; margin-bottom: 10px;">‚úÖ Estatus: COMPLETADO</div>
                            <div style="color: #cbd5e1; font-size: 13px; margin-bottom: 10px;">üì∏ ${existingPhotos.length} foto${existingPhotos.length > 1 ? 's' : ''} capturada${existingPhotos.length > 1 ? 's' : ''}:</div>
                            ${existingPhotos.map((photo, index) => `
                                <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 15px;">
                                    <img src="${photo.photo}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px;">
                                    <div style="flex: 1;">
                                        <div style="color: #cbd5e1; font-size: 12px;">Captura #${index + 1}</div>
                                        <div style="color: #fbbf24; font-size: 13px; font-weight: 600; font-family: 'Courier New', monospace;">‚è∞ ${formatTime(new Date(photo.timestamp))}</div>
                                    </div>
                                </div>
                            `).join('')}
                            <div style="color: #94a3b8; font-size: 12px; margin-top: 10px; font-style: italic;">üí° Puede capturar una nueva foto si lo requiere</div>
                        </div>
                    `;
                }
            }
        }
        
        let timestampInterval;
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                const video = document.getElementById('video');
                video.srcObject = stream;
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('cameraView').style.display = 'block';
                timestampInterval = setInterval(() => {
                    const now = new Date();
                    document.getElementById('liveTimestamp').textContent = formatTime(now);
                }, 1000);
            } catch (error) { alert('Error al acceder a la c√°mara: ' + error.message); }
        }
        
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            currentTimestamp = new Date().toISOString();
            document.getElementById('capturedImage').src = currentPhotoData;
            document.getElementById('capturedTimestamp').textContent = `‚è∞ ${formatTime(new Date(currentTimestamp))}`;
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'block';
            stopCamera();
        }
        
        function retakePhoto() {
            currentPhotoData = null; currentTimestamp = null;
            document.getElementById('photoPreview').style.display = 'none';
            startCamera();
        }
        
        function confirmPhoto() {
            const checkpoint = checkpoints[currentCheckpointIndex];
            const photoData = { checkpoint: checkpoint.key, label: checkpoint.label, emoji: checkpoint.emoji, photo: currentPhotoData, timestamp: currentTimestamp };
            if (!capturedPhotos[checkpoint.key]) capturedPhotos[checkpoint.key] = [];
            capturedPhotos[checkpoint.key].push(photoData);
            if (checkpoint.key === 'beacon_off' && !beaconOffTime) beaconOffTime = new Date(currentTimestamp);
            saveCheckpointToServer(photoData);
            nextCheckpoint();
        }
        
        function skipCheckpoint() { nextCheckpoint(); }
        
        // ‚îÄ‚îÄ Saltar directo a incidentes, guardando posici√≥n actual ‚îÄ‚îÄ
        function skipToIncidents() {
            savedCheckpointIndex = currentCheckpointIndex;
            stopCamera();
            goToIncidents();
        }
        
        function saveBriefingAndContinue() {
            const checkpoint = checkpoints[currentCheckpointIndex];
            const topics = [];
            BRIEFING_TOPICS.forEach(topic => {
                const checkbox = document.getElementById(`topic-${topic.id}`);
                if (checkbox && checkbox.checked) topics.push(topic.label);
            });
            const notes = document.getElementById('briefingNotes').value;
            briefingTopics = topics;
            briefingNotes = notes;
            const briefingData = { checkpoint: checkpoint.key, label: checkpoint.label, emoji: checkpoint.emoji, timestamp: new Date().toISOString(), briefingTopics: topics, briefingNotes: notes };
            if (!capturedPhotos[checkpoint.key]) capturedPhotos[checkpoint.key] = [];
            capturedPhotos[checkpoint.key].push(briefingData);
            const data = {
                action: 'saveInspection', airline: selectedAirline, flightType: selectedFlightType,
                flightNumber: flightNumberValue, flightTimestamp: flightTimestamp,
                inspector: inspectionUser.username, role: inspectionUser.role,
                step: currentCheckpointIndex + 1, item: briefingData.label,
                timestamp: briefingData.timestamp, status: 'En Proceso',
                briefingTopics: topics, briefingNotes: notes
            };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).catch(error => console.error('Error:', error));
            nextCheckpoint();
        }
        
        function previousCheckpoint() { if (currentCheckpointIndex > 0) { stopCamera(); currentCheckpointIndex--; renderCheckpoint(); } }
        function nextCheckpoint() { stopCamera(); currentCheckpointIndex++; if (currentCheckpointIndex < checkpoints.length) renderCheckpoint(); else goToIncidents(); }
        function stopCamera() { if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; } if (timestampInterval) { clearInterval(timestampInterval); timestampInterval = null; } }
        function formatTime(date) { return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
        
        function saveCheckpointToServer(photoData) {
            const data = {
                action: 'saveInspection', airline: selectedAirline, flightType: selectedFlightType,
                flightNumber: flightNumberValue, flightTimestamp: flightTimestamp,
                inspector: inspectionUser.username, role: inspectionUser.role,
                step: currentCheckpointIndex + 1, item: photoData.label,
                timestamp: photoData.timestamp, status: 'En Proceso',
                photoBase64: photoData.photo,
                briefingTopics: photoData.briefingTopics || null,
                briefingNotes: photoData.briefingNotes || null
            };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).catch(error => console.error('Error:', error));
        }
        
        function goToIncidents() {
            stopCamera();
            hideStep(1);
            document.getElementById('step-incident').classList.add('active');
            document.getElementById('stepCounter').textContent = 'Incidentes y Observaciones';
            renderIncidentPhotoSelector();
        }
        
        function toggleIncidentForm(show) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('incidentForm').style.display = show ? 'block' : 'none';
        }
        
        function selectSeverity(severity) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        function renderIncidentPhotoSelector() {
            const selector = document.getElementById('incidentPhotoSelector');
            const allPhotos = [];
            for (const key in capturedPhotos) {
                if (capturedPhotos[key] && capturedPhotos[key].length > 0) {
                    capturedPhotos[key].forEach((photo, index) => {
                        if (photo.photo) {
                            const label = capturedPhotos[key].length > 1 ? `${photo.emoji} ${photo.label} #${index + 1}` : `${photo.emoji} ${photo.label}`;
                            allPhotos.push({ photo: photo.photo, label: label, key: key, index: index, fullData: photo });
                        }
                    });
                }
            }
            selector.innerHTML = allPhotos.map((item, idx) => `
                <div class="photo-selector-item" onclick="selectIncidentPhoto('${item.key}', ${item.index}, '${item.label.replace(/'/g, "\\'")}')">
                    <img src="${item.photo}" alt="${item.label}">
                    <div class="photo-selector-label">${item.label}</div>
                </div>
            `).join('');
        }
        
        function selectIncidentPhoto(key, index, label) {
            document.querySelectorAll('.photo-selector-item').forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            selectedIncidentPhoto = { key, index, label };
        }
        
        // √çndice guardado cuando el inspector us√≥ "‚ö†Ô∏è Ir a Incidentes"
        let savedCheckpointIndex = null;

        function returnToCheckpoint() {
            document.getElementById('step-incident').classList.remove('active');
            // Regresar al checkpoint donde estaba antes de ir a incidentes
            // Si no hay √≠ndice guardado, ir al √∫ltimo checkpoint
            currentCheckpointIndex = (savedCheckpointIndex !== null) ? savedCheckpointIndex : Math.max(0, checkpoints.length - 1);
            savedCheckpointIndex = null;
            showStep(1);
            renderCheckpoint();
        }
        
        function completeInspection() {
            stopCamera();
            const hasIncident = document.getElementById('incidentSi').checked;
            if (hasIncident) {
                const type = document.getElementById('incidentType').value;
                const severity = document.querySelector('input[name="severity"]:checked');
                const description = document.getElementById('incidentDescription').value;
                if (!type || !severity || !description) { alert('Por favor complete todos los campos del incidente'); return; }
                incidentData = { type: type, severity: severity.value, description: description, photoReference: selectedIncidentPhoto ? selectedIncidentPhoto.key : null, photoIndex: selectedIncidentPhoto ? selectedIncidentPhoto.index : null, photoLabel: selectedIncidentPhoto ? selectedIncidentPhoto.label : null };
            }
            document.getElementById('step-incident').classList.remove('active');
            showCompletionScreen();
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'updateStatus', airline: selectedAirline, flightNumber: flightNumberValue, status: 'Completado', timestamp: new Date().toISOString(), incident: incidentData }) }).catch(error => console.error('Error:', error));
        }
        
        function showCompletionScreen() {
            const airlineNames = { 'DL': 'Delta', 'WN': 'Southwest', 'E9': 'Iberojet', 'AV': 'Avianca', 'UA': 'United', 'AA': 'American Airlines', 'WS': 'Westjet', 'PO': 'Porter' };
            const flightTypeNames = { 'TURN': 'TURN (Turnaround)', 'RON-ARRIVAL': 'RON - Llegada', 'RON-DEPARTURE': 'RON - Salida' };
            document.getElementById('summaryAirline').textContent = airlineNames[selectedAirline] || selectedAirline;
            document.getElementById('summaryFlightType').textContent = flightTypeNames[selectedFlightType];
            document.getElementById('summaryFlight').textContent = flightNumberValue;
            document.getElementById('summaryInspector').textContent = inspectionUser.username;
            let totalPhotos = 0, completedCheckpoints = 0;
            for (const key in capturedPhotos) {
                if (capturedPhotos[key] && capturedPhotos[key].length > 0) {
                    completedCheckpoints++;
                    capturedPhotos[key].forEach(photo => { if (photo.photo) totalPhotos++; });
                }
            }
            document.getElementById('summaryPhotoCount').textContent = totalPhotos;
            document.getElementById('summaryCheckpoints').textContent = `${completedCheckpoints} / ${checkpoints.length}`;
            if (beaconOffTime) {
                document.getElementById('timeMetricsCard').style.display = 'block';
                const metricsContent = document.getElementById('timeMetricsContent');
                const metricsHtml = [];
                for (const key in capturedPhotos) {
                    if (capturedPhotos[key] && capturedPhotos[key].length > 0) {
                        capturedPhotos[key].forEach((photo, index) => {
                            if (photo.photo) {
                                const photoTime = new Date(photo.timestamp);
                                const diff = calculateTimeDiff(photoTime);
                                const label = capturedPhotos[key].length > 1 ? `${photo.emoji} ${photo.label} #${index + 1}` : `${photo.emoji} ${photo.label}`;
                                metricsHtml.push(`<div class="summary-item"><span class="summary-label">${label}</span><span class="summary-value">${formatTime(photoTime)}<span class="${diff.className}">${diff.text}</span></span></div>`);
                            }
                        });
                    }
                }
                metricsContent.innerHTML = metricsHtml.join('');
            }
            if (incidentData) {
                document.getElementById('incidentCard').style.display = 'block';
                document.getElementById('incidentSummary').innerHTML = `
                    <div class="summary-item"><span class="summary-label">Tipo:</span><span class="summary-value">${incidentData.type}</span></div>
                    <div class="summary-item"><span class="summary-label">Severidad:</span><span class="summary-value">${incidentData.severity}</span></div>
                    <div class="summary-item"><span class="summary-label">Descripci√≥n:</span><span class="summary-value">${incidentData.description}</span></div>
                    ${incidentData.photoReference ? `<div class="summary-item"><span class="summary-label">Foto:</span><span class="summary-value">${incidentData.photoLabel}</span></div>` : ''}
                `;
            }
            const gallery = document.getElementById('photoGallery');
            const galleryHtml = [];
            for (const key in capturedPhotos) {
                if (capturedPhotos[key] && capturedPhotos[key].length > 0) {
                    capturedPhotos[key].forEach((photo, index) => {
                        if (photo.photo) {
                            const photoTime = new Date(photo.timestamp);
                            const diff = beaconOffTime ? calculateTimeDiff(photoTime) : null;
                            const label = capturedPhotos[key].length > 1 ? `${photo.emoji} ${photo.label} #${index + 1}` : `${photo.emoji} ${photo.label}`;
                            galleryHtml.push(`<div class="gallery-item"><img src="${photo.photo}" alt="${label}">${diff ? `<div class="gallery-timestamp ${diff.className}">${diff.text}</div>` : ''}<div class="gallery-label">${label}</div></div>`);
                        }
                    });
                }
            }
            gallery.innerHTML = galleryHtml.join('');
            document.getElementById('completionScreen').classList.add('active');
        }
        
        function calculateTimeDiff(photoTime) {
            if (!beaconOffTime) return { text: '', className: '' };
            const diffMs = photoTime - beaconOffTime;
            const diffMins = Math.floor(Math.abs(diffMs) / 60000);
            const diffSecs = Math.floor((Math.abs(diffMs) % 60000) / 1000);
            const sign = diffMs >= 0 ? '+' : '-';
            const text = `${sign}${diffMins}m ${diffSecs}s`;
            let className = 'time-diff ';
            if (diffMs < 0) className += 'negative';
            else if (diffMins <= 30) className += 'optimal';
            else if (diffMins <= 60) className += 'warning';
            else className += 'critical';
            return { text, className };
        }
        
        function newReport() {
            selectedAirline = ''; selectedFlightType = ''; flightNumberValue = ''; flightTimestamp = '';
            currentCheckpointIndex = 0; checkpoints = []; capturedPhotos = {};
            currentPhotoData = null; currentTimestamp = null; beaconOffTime = null;
            briefingTopics = []; briefingNotes = ''; incidentData = null; selectedIncidentPhoto = null;
            document.getElementById('airlineSelect').value = '';
            document.getElementById('flightTypeSelect').value = '';
            document.getElementById('flightNumber').value = '';
            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('progressBar').style.width = '0%';
            showStep(0);
            document.getElementById('stepCounter').textContent = 'Seleccione la aerol√≠nea';
        }

        // ‚îÄ‚îÄ Guardar reporte inmediatamente (desde pantalla de incidentes) ‚îÄ‚îÄ
        function saveReportNow() {
            stopCamera();
            // Recoge incidente si el inspector lo marc√≥
            const hasIncident = document.getElementById('incidentSi').checked;
            if (hasIncident) {
                const type = document.getElementById('incidentType').value;
                const severity = document.querySelector('input[name="severity"]:checked');
                const description = document.getElementById('incidentDescription').value;
                if (!type || !severity || !description) {
                    alert('Por favor complete todos los campos del incidente antes de guardar');
                    return;
                }
                incidentData = {
                    type: type, severity: severity.value, description: description,
                    photoReference: selectedIncidentPhoto ? selectedIncidentPhoto.key : null,
                    photoIndex: selectedIncidentPhoto ? selectedIncidentPhoto.index : null,
                    photoLabel: selectedIncidentPhoto ? selectedIncidentPhoto.label : null
                };
            }
            document.getElementById('step-incident').classList.remove('active');
            showCompletionScreen();
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'updateStatus', airline: selectedAirline,
                    flightNumber: flightNumberValue, status: 'Completado',
                    timestamp: new Date().toISOString(), incident: incidentData
                })
            }).catch(error => console.error('Error:', error));
        }

        // ‚îÄ‚îÄ Navegar al historial ‚îÄ‚îÄ
        function goToHistory() {
            stopCamera();
            window.location.href = 'history-Photo9.html';
        }
        
        function logout() {
            if (confirm('¬øEst√° seguro de que desea cerrar sesi√≥n?')) {
                stopCamera();
                sessionStorage.removeItem('user');
                window.location.href = 'login-Photo9.html';
            }
        }
        
        console.log('üì∏ Turnaround Check cargado');
        console.log('üë§ Usuario:', inspectionUser.username);
    </script>

        </div><!-- /app-content -->
    </div><!-- /app-shell -->
</body>
</html>
