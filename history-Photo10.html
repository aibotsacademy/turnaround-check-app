<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Historial - Turnaround Check</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&display=swap');

        :root {
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --bg: #050816;
            --surface: rgba(15, 23, 42, 0.85);
            --border: rgba(59, 130, 246, 0.2);
            --text: #e2e8f0;
            --muted: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            color: var(--text);
        }

        #canvas-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; z-index: 1;
            pointer-events: none;
        }

        .app {
            position: relative; z-index: 2;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            padding: 14px 16px 10px;
            border-bottom: 1px solid var(--border);
            background: rgba(5, 8, 22, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 10;
        }

        /* Top row: logo + user + logout */
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .header-brand { display: flex; align-items: center; gap: 9px; }

        .logo-icon {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; flex-shrink: 0;
        }

        .logo-text {
            font-size: 16px; font-weight: 800;
            background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1.1;
        }
        .logo-sub {
            font-size: 9px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px; text-transform: uppercase;
        }

        .header-meta { display: flex; align-items: center; gap: 8px; }

        .user-chip {
            display: flex; align-items: center; gap: 7px;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid var(--border);
            border-radius: 20px; padding: 5px 10px 5px 5px;
        }
        .user-chip .avatar {
            width: 24px; height: 24px; border-radius: 50%;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: #fff;
        }
        .user-chip .name { font-size: 12px; font-weight: 600; max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .user-chip .role { font-size: 9px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }

        .btn-logout {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px; color: #fca5a5;
            font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            font-family: 'Syne', sans-serif;
            white-space: nowrap;
        }
        .btn-logout:active { background: rgba(239, 68, 68, 0.25); }

        /* CTA Nueva Inspecci√≥n ‚Äî centrado, protagonista */
        .btn-new-wrap {
            display: flex;
            justify-content: center;
        }

        .btn-new {
            width: 100%;
            padding: 13px 20px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border: none; border-radius: 12px;
            color: #fff; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.18s;
            font-family: 'Syne', sans-serif;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 18px rgba(59,130,246,0.35);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-new:active { transform: scale(0.97); box-shadow: 0 2px 8px rgba(59,130,246,0.25); }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main { padding: 16px; flex: 1; }

        /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px; margin-bottom: 16px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 16px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .stat-label {
            font-size: 9px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 2px;
            color: var(--muted); font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px; font-weight: 800;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1;
        }
        .stat-value.green { background: linear-gradient(135deg, var(--green), #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value.yellow { background: linear-gradient(135deg, var(--yellow), #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
        .toolbar {
            display: flex; align-items: center;
            justify-content: space-between;
            margin-bottom: 12px; gap: 8px;
        }

        .toolbar-title {
            font-size: 16px; font-weight: 800;
            display: flex; align-items: center; gap: 8px;
        }

        .toolbar-right { display: flex; align-items: center; gap: 6px; }

        .filter-pills {
            display: flex; gap: 6px;
            margin-bottom: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 2px;
        }
        .filter-pills::-webkit-scrollbar { display: none; }

        .filter-pill {
            padding: 6px 14px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap; flex-shrink: 0;
        }
        .filter-pill.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--blue); color: var(--blue);
        }
        .filter-pill:active { opacity: 0.7; }

        .refresh-btn {
            width: 34px; height: 34px; flex-shrink: 0;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px; color: var(--blue);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 17px;
        }
        .refresh-btn:active { background: rgba(59, 130, 246, 0.25); }
        .refresh-btn.spinning { animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ LIVE INDICATOR ‚îÄ‚îÄ */
        .live-badge {
            display: flex; align-items: center; gap: 5px;
            font-size: 10px; font-weight: 600;
            color: var(--green); font-family: 'JetBrains Mono', monospace;
        }
        .live-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--green);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.7); }
        }

        /* ‚îÄ‚îÄ REPORT LIST ‚îÄ‚îÄ */
        .reports-list { display: flex; flex-direction: column; gap: 10px; }

        .report-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden; cursor: pointer;
            transition: all 0.22s;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            animation: cardIn 0.35s ease both;
        }
        @keyframes cardIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .report-card:active { transform: scale(0.985); }
        .report-card.status-completado { border-left: 3px solid var(--green); }
        .report-card.status-en-proceso { border-left: 3px solid var(--yellow); }

        .report-header {
            padding: 13px 14px;
            display: flex; align-items: center;
            justify-content: space-between; gap: 10px;
        }

        .report-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }

        .airline-badge {
            width: 42px; height: 42px; border-radius: 11px;
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2));
            border: 1px solid rgba(59,130,246,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 800;
            color: var(--blue); flex-shrink: 0;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-info { flex: 1; min-width: 0; }

        .report-title {
            font-size: 14px; font-weight: 700;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 7px;
        }

        .flight-type-tag {
            font-size: 9px; font-weight: 700;
            padding: 2px 7px; border-radius: 5px;
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }
        .tag-turn { background: rgba(59,130,246,0.15); color: var(--blue); }
        .tag-ron-arrival { background: rgba(16,185,129,0.15); color: var(--green); }
        .tag-ron-departure { background: rgba(245,158,11,0.15); color: var(--yellow); }

        .report-meta {
            font-size: 11px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .report-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

        .status-chip {
            padding: 3px 10px; border-radius: 20px;
            font-size: 10px; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .chip-completado { background: rgba(16,185,129,0.15); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
        .chip-en-proceso { background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.3); }

        .progress-mini {
            width: 60px; height: 4px;
            background: rgba(30,41,59,0.6);
            border-radius: 10px; overflow: hidden;
            margin-top: 5px;
        }
        .progress-mini-fill {
            height: 100%; border-radius: 10px;
            background: linear-gradient(90deg, var(--blue), var(--purple));
            transition: width 0.4s ease;
        }
        .progress-mini-fill.done { background: linear-gradient(90deg, var(--green), #059669); }

        .pct-label {
            text-align: right; font-size: 9px;
            color: var(--muted); font-family: 'JetBrains Mono', monospace;
            margin-top: 2px;
        }

        .chevron {
            color: var(--muted); font-size: 18px;
            transition: transform 0.25s;
        }
        .report-card.expanded .chevron { transform: rotate(90deg); }

        /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
        .report-detail {
            max-height: 0; overflow: hidden;
            transition: max-height 0.35s ease;
            padding: 0 14px;
            border-top: 0px solid transparent;
        }
        .report-card.expanded .report-detail {
            max-height: 1200px;
            padding: 0 14px 14px;
            border-top: 1px solid var(--border);
        }

        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px; margin-bottom: 12px; padding-top: 12px;
        }

        .detail-item {
            background: rgba(30,41,59,0.4);
            border: 1px solid rgba(59,130,246,0.1);
            border-radius: 9px; padding: 9px 11px;
        }
        .detail-item .d-label {
            font-size: 9px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 2px;
        }
        .detail-item .d-value { font-size: 13px; font-weight: 600; }

        .cp-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .cp-table th {
            text-align: left; padding: 6px 8px;
            font-size: 9px; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            border-bottom: 1px solid rgba(59,130,246,0.15);
        }
        .cp-table td {
            padding: 6px 8px; font-size: 11px;
            border-bottom: 1px solid rgba(30,41,59,0.5);
            font-family: 'JetBrains Mono', monospace;
        }
        .cp-table tr:last-child td { border-bottom: none; }
        .cp-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .cp-done { background: var(--green); }
        .cp-pending { background: var(--muted); }

        .btn-resume {
            width: 100%; margin-top: 12px;
            padding: 13px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border: none; border-radius: 10px; color: #fff;
            font-size: 14px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; font-family: 'Syne', sans-serif;
        }
        .btn-resume:active { transform: scale(0.97); }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state {
            text-align: center; padding: 50px 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            backdrop-filter: blur(12px);
        }
        .empty-icon { font-size: 48px; margin-bottom: 14px; }
        .empty-title { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
        .empty-sub { color: var(--muted); font-size: 13px; }

        /* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
        .skeleton {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 16px;
            animation: shimmer 1.4s ease-in-out infinite;
        }
        @keyframes shimmer { 0%, 100% { opacity: 1; } 50% { opacity: 0.45; } }
        .skel-line { height: 13px; border-radius: 6px; background: rgba(59,130,246,0.1); margin-bottom: 8px; }
        .skel-line.short { width: 40%; }
        .skel-line.med { width: 65%; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px);
            background: rgba(16,185,129,0.92);
            backdrop-filter: blur(10px);
            color: #fff; padding: 11px 22px;
            border-radius: 24px; font-size: 13px; font-weight: 600;
            z-index: 100; opacity: 0;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: rgba(239,68,68,0.92); }

        /* ‚îÄ‚îÄ DUPLICATE BANNER ‚îÄ‚îÄ */
        .duplicate-banner {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.35);
            border-radius: 12px; padding: 10px 14px;
            margin-bottom: 12px; display: none;
            font-size: 12px; color: #fcd34d;
            line-height: 1.4;
        }
        .duplicate-banner.visible { display: block; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div class="app">
        <header class="header">
            <div class="header-top">
                <div class="header-brand">
                    <div class="logo-icon">‚úàÔ∏è</div>
                    <div>
                        <div class="logo-text">Flights Report</div>
                        <div class="logo-sub">Turnaround Check</div>
                    </div>
                </div>
                <div class="header-meta">
                    <div class="user-chip">
                        <div class="avatar" id="avatarInitial">?</div>
                        <div>
                            <div class="name" id="userNameDisplay">‚Äì</div>
                            <div class="role" id="userRoleDisplay">‚Äì</div>
                        </div>
                    </div>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
            </div>
            <div class="btn-new-wrap">
                <button class="btn-new" onclick="goToNewInspection()">
                    ‚úàÔ∏è + Nueva Inspecci√≥n
                </button>
            </div>
        </header>

        <main class="main">
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="statTotal">‚Äì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completados</div>
                    <div class="stat-value green" id="statDone">‚Äì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">En Proceso</div>
                    <div class="stat-value yellow" id="statPending">‚Äì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Hoy</div>
                    <div class="stat-value" id="statToday">‚Äì</div>
                </div>
            </div>

            <!-- Duplicate warning -->
            <div class="duplicate-banner" id="duplicateBanner">
                ‚ö†Ô∏è <span id="duplicateMsg">Tienes reportes sin completar activos.</span>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-title">
                    üìã Mis Reportes
                    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
                </div>
                <div class="refresh-btn" id="refreshBtn" onclick="loadReports(true)">‚Üª</div>
            </div>
            <div class="filter-pills">
                <button class="filter-pill active" onclick="setFilter('all', this)">Todos</button>
                <button class="filter-pill" onclick="setFilter('Completado', this)">Completados</button>
                <button class="filter-pill" onclick="setFilter('En Proceso', this)">En Proceso</button>
            </div>

            <!-- List -->
            <div class="reports-list" id="reportsList">
                <!-- skeleton -->
                <div class="skeleton" id="skeleton1">
                    <div class="skel-line med"></div>
                    <div class="skel-line short"></div>
                </div>
                <div class="skeleton" id="skeleton2">
                    <div class="skel-line med"></div>
                    <div class="skel-line short"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
        const HISTORY_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxx4p3plw4z3Zj81MJYsPft5AgdNYI2sduIRo8Nac1fUrWt-79OQ7J4Urj3QZN_HoUA/exec';

        // ‚îÄ‚îÄ USER ‚îÄ‚îÄ
        let currentUser = null;
        let allReports = [];
        let currentFilter = 'all';
        let autoRefreshTimer = null;
        const REFRESH_INTERVAL = 30000; // 30s auto refresh

        const userDataStr = sessionStorage.getItem('user');
        if (!userDataStr) {
            alert('Sesi√≥n no encontrada. Por favor inicie sesi√≥n.');
            window.location.href = 'login-Photo10.html';
        } else {
            try {
                currentUser = JSON.parse(userDataStr);
                initUI();
                loadReports();
                startAutoRefresh();
            } catch(e) {
                window.location.href = 'login-Photo10.html';
            }
        }

        function initUI() {
            document.getElementById('userNameDisplay').textContent = currentUser.username;
            document.getElementById('userRoleDisplay').textContent = currentUser.role;
            document.getElementById('avatarInitial').textContent =
                (currentUser.username || '?').slice(0, 2).toUpperCase();
        }

        // ‚îÄ‚îÄ THREE.JS BACKGROUND ‚îÄ‚îÄ
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const cam3 = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        const pg = new THREE.BufferGeometry();
        const pc = 2000;
        const pa = new Float32Array(pc * 3);
        for (let i = 0; i < pc * 3; i++) pa[i] = (Math.random() - 0.5) * 100;
        pg.setAttribute('position', new THREE.BufferAttribute(pa, 3));
        const pm = new THREE.PointsMaterial({ size: 0.06, color: 0x3b82f6, transparent: true, opacity: 0.5, blending: THREE.AdditiveBlending });
        const pts = new THREE.Points(pg, pm);
        scene.add(pts);
        cam3.position.z = 30;
        (function anim() { requestAnimationFrame(anim); pts.rotation.y += 0.0008; renderer.render(scene, cam3); })();
        window.addEventListener('resize', () => { cam3.aspect = window.innerWidth / window.innerHeight; cam3.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        // ‚îÄ‚îÄ DEBUG PANEL ‚îÄ‚îÄ
        function runDebug() {
            const panel = document.getElementById('debugPanel');
            const out   = document.getElementById('debugOut');
            panel.style.display = 'block';
            out.textContent = '‚è≥ Consultando debugInspector...';

            const cbName = 'dbgCb' + Date.now();
            const url = `${HISTORY_SCRIPT_URL}?action=debugInspector&inspector=${encodeURIComponent(currentUser.username)}&callback=${cbName}`;
            window[cbName] = function(data) {
                delete window[cbName];
                const s = document.getElementById('jsonp-debug');
                if (s) s.remove();

                if (!data || !data.success) {
                    out.textContent = '‚ùå Error: ' + JSON.stringify(data);
                    return;
                }
                let txt = '';
                txt += `‚úÖ lastRow: ${data.lastRow} | lastCol: ${data.lastCol}\n`;
                txt += `üîé colInspector: ${data.colInspector} | colFlightKey: ${data.colFlightKey} | colFecha: ${data.colFecha} | colTasa: ${data.colTasa}\n`;
                txt += `üìã Headers (${data.headers.length}): ${data.headers.join(' | ')}\n\n`;
                txt += `‚úÖ MATCHED (${data.matchedCount} filas para "${data.inspector}"):\n`;
                (data.matched || []).forEach(r => {
                    txt += `  Fila ${r.row}: ${r.flightKey} | fecha: ${r.fecha} | tasa: ${r.tasa}\n`;
                });
                txt += `\n‚è≠ SKIPPED (primeros 10):\n`;
                (data.skipped || []).forEach(r => {
                    txt += `  Fila ${r.row}: [${r.inspector}] motivo: ${r.skip}\n`;
                });
                out.textContent = txt;
            };
            const script = document.createElement('script');
            script.id  = 'jsonp-debug';
            script.src = url;
            document.body.appendChild(script);
        }

        // ‚îÄ‚îÄ LOAD REPORTS ‚îÄ‚îÄ
        function loadReports(manual = false) {
            if (manual) {
                const rb = document.getElementById('refreshBtn');
                rb.classList.add('spinning');
                setTimeout(() => rb.classList.remove('spinning'), 700);
            }

            const cbName = 'histCb' + Date.now();
            const url = `${HISTORY_SCRIPT_URL}?action=getHistory&inspector=${encodeURIComponent(currentUser.username)}&callback=${cbName}`;
            console.log('[History] Requesting:', url);

            window[cbName] = function(data) {
                delete window[cbName];
                const s = document.getElementById('jsonp-history');
                if (s) s.remove();

                console.log('[History] Raw response ‚Äî success:', data && data.success, '| total:', data && data.total, '| reports:', data && data.reports && data.reports.length);
                if (data && data.reports) {
                    data.reports.forEach(r => console.log(`  [Report] ${r.flightKey} | ${r.flightTimestamp} | progress:${r.progress}% | status:${r.status}`));
                }

                if (data && data.success) {
                    allReports = (data.reports || []).map(r => {
                        r.status = (r.progress >= 100) ? 'Completado' : 'En Proceso';
                        return r;
                    });
                    console.log('[History] allReports after normalize:', allReports.length);
                    renderReports();
                    updateStats();
                    checkDuplicates();
                    if (manual) showToast('‚úì Actualizado ‚Äî ' + allReports.length + ' reportes');
                } else {
                    console.warn('[History] No data or error:', JSON.stringify(data));
                    allReports = [];
                    renderReports();
                    updateStats();
                    if (manual) showToast('‚ö† Sin datos del servidor', true);
                }
            };

            const script = document.createElement('script');
            script.id = 'jsonp-history';
            script.src = url;
            script.onerror = () => {
                delete window[cbName];
                script.remove();
                // Show skeletons gone, empty state
                allReports = [];
                renderReports();
                if (manual) showToast('Error de conexi√≥n', true);
            };
            document.body.appendChild(script);

            setTimeout(() => {
                if (window[cbName]) {
                    delete window[cbName];
                    const s = document.getElementById('jsonp-history');
                    if (s) s.remove();
                    allReports = [];
                    renderReports();
                    updateStats();
                }
            }, 12000);
        }

        function startAutoRefresh() {
            autoRefreshTimer = setInterval(() => loadReports(false), REFRESH_INTERVAL);
        }

        // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
        function renderReports() {
            const list = document.getElementById('reportsList');

            const filtered = currentFilter === 'all'
                ? allReports
                : allReports.filter(r => r.status === currentFilter);

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">${currentFilter === 'all' ? 'Sin reportes a√∫n' : 'Sin reportes con este filtro'}</div>
                        <div class="empty-sub">Tus inspecciones aparecer√°n aqu√≠ en tiempo real.</div>
                    </div>`;
                return;
            }

            // Sort newest first ‚Äî robust date parser
            const sorted = [...filtered].sort((a, b) => parseFlightDate(b) - parseFlightDate(a));

            list.innerHTML = sorted.map((r, i) => buildCard(r, i)).join('');
        }

        // ‚îÄ‚îÄ Parsea fecha de vuelo con fallback robusto ‚îÄ‚îÄ
        // Maneja ISO, "M/D/YYYY HH:MM:SS", y timestamp embebido en flightKey
        function parseFlightDate(r) {
            try {
                var ts = r.flightTimestamp || '';
                if (!ts && r.flightKey) {
                    var m = r.flightKey.match(/(\d{4}-\d{2}-\d{2}T[\d:.Z]+)/);
                    if (m) ts = m[1];
                }
                if (!ts) return 0;
                var d = new Date(ts);
                if (!isNaN(d.getTime())) return d.getTime();
                // MM/DD/YYYY HH:MM:SS
                var parts = ts.match(/(\d+)\/(\d+)\/(\d+)\s+(\d+):(\d+):?(\d*)/);
                if (parts) return new Date(
                    parseInt(parts[3]), parseInt(parts[1])-1, parseInt(parts[2]),
                    parseInt(parts[4]), parseInt(parts[5]), parseInt(parts[6]||0)
                ).getTime();
                return 0;
            } catch(e) { return 0; }
        }

        // ‚îÄ‚îÄ Normaliza timestamps de Google Sheets ‚îÄ‚îÄ
        // Sheets guarda horas puras como fecha 1899-12-30 o como string "HH:MM:SS"
        function normalizeTs(ts) {
            if (!ts) return '‚Äì';
            try {
                // Tomar solo la primera l√≠nea (briefing puede tener m√∫ltiples l√≠neas)
                const raw = String(ts).split('\n')[0].trim();

                // Ya viene como HH:MM:SS o HH:MM directo
                if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(raw)) return raw;

                const d = new Date(raw);
                if (isNaN(d.getTime())) return raw;

                // A√±o 1899 = hora pura de Sheets sin fecha real ‚Üí extraer solo la hora
                if (d.getFullYear() <= 1900) {
                    return d.toLocaleTimeString('es-CR', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }

                // Fecha v√°lida ‚Üí mostrar solo hora
                return d.toLocaleTimeString('es-CR', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                });
            } catch(e) {
                return String(ts).split('\n')[0].trim();
            }
        }

        // ‚îÄ‚îÄ Elimina checkpoints duplicados (mismo label) ‚îÄ‚îÄ
        // inicioFOD y fod apuntan a la misma celda del sheet ‚Üí deduplicar
        function dedupeCheckpoints(checkpoints) {
            const seenLabels = new Set();
            return checkpoints.filter(cp => {
                if (seenLabels.has(cp.label)) return false;
                seenLabels.add(cp.label);
                return true;
            });
        }

        function buildCard(r, idx) {
            const airlineDisplay = r.airlineName || r.airline || '‚Äì';
            const airlineCode    = r.airline || '‚Äì';
            const status         = r.status || 'En Proceso';
            const statusClass    = status === 'Completado' ? 'completado' : 'en-proceso';
            const chipClass      = status === 'Completado' ? 'chip-completado' : 'chip-en-proceso';
            const typeTag        = buildTypeTag(r.flightType);
            const progress       = r.progress || 0;
            const progressClass  = status === 'Completado' ? 'done' : '';
            const dt             = r.flightTimestamp ? formatDateTime(new Date(r.flightTimestamp)) : '‚Äì';

            // Deduplicar y limpiar checkpoints
            const checkpoints = dedupeCheckpoints(r.checkpoints || []);

            const tiempoHtml    = r.tiempoTotal ? `&nbsp;¬∑&nbsp;‚è± ${r.tiempoTotal} min` : '';
            const aeropuertoHtml = r.aeropuerto  ? `&nbsp;¬∑&nbsp;üè¢ ${r.aeropuerto}` : '';

            const cpHtml = checkpoints.length > 0 ? `
                <table class="cp-table">
                    <thead>
                        <tr>
                            <th>Checkpoint</th>
                            <th>Hora registrada</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${checkpoints.map(cp => `
                            <tr>
                                <td>${cp.emoji || ''} ${cp.label}</td>
                                <td style="font-family:'JetBrains Mono',monospace;">${normalizeTs(cp.timestamp)}</td>
                                <td><span class="cp-dot cp-done"></span>Completado</td>
                            </tr>`).join('')}
                    </tbody>
                </table>`
                : '<div style="color:var(--muted);font-size:12px;padding-top:10px;font-family:\'JetBrains Mono\',monospace;">Sin checkpoints registrados a√∫n.</div>';

            const resumeBtn = status !== 'Completado' ? `
                <button class="btn-resume" onclick="resumeReport(event, ${JSON.stringify(r).replace(/"/g, '&quot;')})">
                    ‚ñ∂ Retomar Inspecci√≥n
                </button>` : '';

            const incidentHtml = r.incident ? `
                <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 12px;margin-top:10px;">
                    <div style="font-size:11px;color:#fca5a5;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:4px;">‚ö† INCIDENTE: ${r.incident.type}</div>
                    <div style="font-size:12px;color:var(--text);">${r.incident.description || ''}</div>
                    <div style="font-size:11px;color:var(--muted);margin-top:4px;">Severidad: ${r.incident.severity}</div>
                </div>` : '';

            return `
                <div class="report-card status-${statusClass}" style="animation-delay:${idx * 0.05}s" onclick="toggleCard(this)">
                    <div class="report-header">
                        <div class="report-left">
                            <div class="airline-badge">${airlineCode}</div>
                            <div class="report-info">
                                <div class="report-title">
                                    ${airlineDisplay} ¬∑ Vuelo ${r.flightNumber || '‚Äì'}
                                    ${typeTag}
                                </div>
                                <div class="report-meta">
                                    üìÖ ${dt}${aeropuertoHtml}${tiempoHtml}
                                    ${r.incident ? '&nbsp;¬∑&nbsp;<span style="color:var(--red);">‚ö† Incidente</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="report-right">
                            <div>
                                <span class="status-chip ${chipClass}">${status}</span>
                                <div class="progress-mini">
                                    <div class="progress-mini-fill ${progressClass}" style="width:${progress}%"></div>
                                </div>
                                <div class="pct-label">${Math.round(progress)}%</div>
                            </div>
                            <div class="chevron">‚Ä∫</div>
                        </div>
                    </div>
                    <div class="report-detail">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="d-label">Aerol√≠nea</div>
                                <div class="d-value">${airlineDisplay}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Tipo de Vuelo</div>
                                <div class="d-value">${r.flightType || '‚Äì'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">N¬∞ Vuelo</div>
                                <div class="d-value">${r.flightNumber || '‚Äì'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Inspector</div>
                                <div class="d-value">${r.inspector || currentUser.username}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Aeropuerto</div>
                                <div class="d-value">${r.aeropuerto || '‚Äì'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Items</div>
                                <div class="d-value">${r.itemsCompletados || checkpoints.length} / ${r.itemsTotales || 23}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Tiempo Total</div>
                                <div class="d-value">${r.tiempoTotal ? r.tiempoTotal + ' min' : '‚Äì'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="d-label">Completitud</div>
                                <div class="d-value" style="background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:18px;">${Math.round(progress)}%</div>
                            </div>
                        </div>
                        ${cpHtml}
                        ${incidentHtml}
                        ${resumeBtn}
                    </div>
                </div>`;
        }

        function buildTypeTag(type) {
            const map = {
                'TURN': ['tag-turn', 'TURN'],
                'RON-ARRIVAL': ['tag-ron-arrival', 'ARRIVAL'],
                'RON-DEPARTURE': ['tag-ron-departure', 'DEPART']
            };
            const [cls, label] = map[type] || ['tag-turn', type || '‚Äì'];
            return `<span class="flight-type-tag ${cls}">${label}</span>`;
        }

        // ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
        function updateStats() {
            const today = new Date().toDateString();
            const done = allReports.filter(r => r.status === 'Completado').length;
            const pending = allReports.filter(r => r.status !== 'Completado').length;
            const todayCount = allReports.filter(r => {
                try { return new Date(parseFlightDate(r)).toDateString() === today; } catch { return false; }
            }).length;

            document.getElementById('statTotal').textContent = allReports.length;
            document.getElementById('statDone').textContent = done;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statToday').textContent = todayCount;
        }

        // ‚îÄ‚îÄ DUPLICATE CHECK ‚îÄ‚îÄ
        function checkDuplicates() {
            const inProgress = allReports.filter(r => r.status === 'En Proceso');
            const banner = document.getElementById('duplicateBanner');
            if (inProgress.length > 0) {
                banner.classList.add('visible');
                const flights = inProgress.map(r => `${r.airline} ${r.flightNumber}`).join(', ');
                document.getElementById('duplicateMsg').textContent =
                    `‚ö†Ô∏è Tienes ${inProgress.length} reporte(s) sin completar: ${flights}. ¬øDeseas retomarlo?`;
            } else {
                banner.classList.remove('visible');
            }
        }

        // ‚îÄ‚îÄ TOGGLE CARD ‚îÄ‚îÄ
        function toggleCard(el) {
            el.classList.toggle('expanded');
        }

        // ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
        function setFilter(f, el) {
            currentFilter = f;
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            renderReports();
        }

        // ‚îÄ‚îÄ RESUME REPORT ‚îÄ‚îÄ
        function resumeReport(e, report) {
            e.stopPropagation();
            // Store the in-progress report context so TURN-Photo9 can pre-fill
            sessionStorage.setItem('resumeReport', JSON.stringify(report));
            window.location.href = 'TURN-Photo10.html';
        }

        // ‚îÄ‚îÄ NEW INSPECTION ‚îÄ‚îÄ
        function goToNewInspection() {
            // Clear any resume context
            sessionStorage.removeItem('resumeReport');
            window.location.href = 'TURN-Photo10.html';
        }

        // ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                sessionStorage.clear();
                window.location.href = 'login-Photo10.html';
            }
        }

        // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
        function formatTime(d) {
            return d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        function formatDateTime(d) {
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })
                + ' ' + formatTime(d);
        }

        // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
        function showToast(msg, isErr = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (isErr ? ' error' : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2800);
        }
    </script>

</body>
</html>
